name: Update Gold Rate

on:
  schedule:
    - cron: '34 8 * * *'  # Runs every day at 8:34 AM UTC
  workflow_dispatch:  # Allows manual run


jobs:
  update-gold-rate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install node-fetch@2

      - name: Scrape gold rate and update page
        run: |
          node -e "
          const fetch = require('node-fetch');
          const fs = require('fs');
          
          async function getGoldRate() {
            const response = await fetch('https://www.malabargoldanddiamonds.com/goldprice');
            const text = await response.text();
            const rateRegex = /<span class=\"price 22kt-price\">(\d{1,3}(?:,\d{3})*\.\d{2}) INR<\/span>/;
            const dateRegex = /<span class=\"date update-date\">([^<]+)<\/span>/;

            const rateMatch = text.match(rateRegex);
            const dateMatch = text.match(dateRegex);

            if (rateMatch && dateMatch) {
              const rate = rateMatch[1];
              const date = dateMatch[1];

              const newRow = \`<tr><td>\${date}</td><td>\${rate}</td></tr>\`;

              const filePath = 'index.html';
              let content = fs.readFileSync(filePath, 'utf8');

              const tableEndIndex = content.lastIndexOf('</tbody>');
              content = content.slice(0, tableEndIndex) + newRow + content.slice(tableEndIndex);

              fs.writeFileSync(filePath, content);
            } else {
              console.log('Failed to fetch the gold rate.');
            }
          }
          
          getGoldRate();
          "

      - name: Commit and push changes
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "GitHub Actions"
          git add index.html
          git commit -m "Update gold rate"
          git push
